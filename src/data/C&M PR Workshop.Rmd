---
title: "C&M PR Workshop"
author: "PAT North West  - NHS England"
date: "2022-10-20"
output:
  html_document:
    toc: true
    toc_depth: 1
    toc_float: true
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

#install.packages("devtools")
#devtools::install_github("PublicHealthEngland/fingertipsR")
library(fingertipsR)
library(tidyverse)
library(leaflet)
library(readxl)
library(rgeos)
library(rgdal)
library(maptools)
library(sp)
library(openxlsx)


## Local Authority Shape File
lads <- geojsonio::geojson_read(
  x = "geo/regions.geojson",  # the same file_path as above
  what = "sp"  # returns the read with spatial class
)

###Filter shapes for North West only
NW_LTLA<-read_excel("ref/NW_LTLA_Mapping.xlsx")
lads_nw<-merge(lads,NW_LTLA, by.x = "lad17cd", "areaCode")
lads_nw<-subset(lads_nw, Region == "North West")

## LSOA Shape file
lsoa<- geojsonio::geojson_read(
  x = "geo/Lower_Layer_Super_Output_Areas_(December_2011)_Boundaries_Super_Generalised_Clipped_(BSC)_EW_V3.geojson",  # the same file_path as above
  what = "sp"  # returns the read with spatial class
)


## CCG Shape File

ccg<-geojsonio::geojson_read(
  x = "geo/Clinical_Commissioning_Groups_(April_2021)_EN_BSC.geojson",  # the same file_path as above
  what = "sp"  # returns the read with spatial class
)


```

# Introduction

# Deprivation

## Indices of Deprivation (IMD) 2019 {.tabset .tabset-fade}

### LSOA Map

The map below shows the decile each LSOA falls into based on their deprivation score. The higher the decile, the more affluent the area, the lower the decile, the more derpived.

```{r Dep prep}

## Load Deprivation Data
imd<-read.xlsx("https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/833970/File_1_-_IMD2019_Index_of_Multiple_Deprivation.xlsx", sheet = 2)
imd<-imd%>%
  left_join(NW_LTLA, c("Local.Authority.District.code.(2019)" = "areaCode"))%>%
  mutate(`Index.of.Multiple.Deprivation.(IMD).Decile` = factor(`Index.of.Multiple.Deprivation.(IMD).Decile`))

## Join Shape files with data
lsoa_data<-merge(lsoa, imd, by.x = "LSOA11CD", "LSOA.code.(2011)")

### Filter for North West
lsoa_data_nw<-subset(lsoa_data, Region == "North West")

## Create palette
pal_fac_imd<-colorFactor(palette = "Blues", levels = 10:1, domain = lsoa_data_nw$`Index.of.Multiple.Deprivation.(IMD).Decile`)

```

```{r Dep Map}


lat<-53.3
lng<--2.5

lsoa_data_cm<-subset(lsoa_data_nw, System == "Cheshire & Merseyside")

lads_cm<-subset(lads_nw, System == "Cheshire & Merseyside")
leaflet(lsoa_data_cm)%>%
  addPolygons(data = lads_cm, color = "black", weight = 2)%>%
  addPolygons(stroke = TRUE, weight = 0.4, opacity = 1, fillOpacity = 0.6,
              color = "grey", fillColor = ~pal_fac_imd(`Index.of.Multiple.Deprivation.(IMD).Decile`),
              label = paste0(lsoa_data_cm$LSOA11NM,": Decile - ", lsoa_data_cm$`Index.of.Multiple.Deprivation.(IMD).Decile`))%>%
  addProviderTiles(providers$CartoDB.Voyager)%>%
  addLegend(values = lsoa_data_cm$`Index.of.Multiple.Deprivation.(IMD).Decile`, pal = pal_fac_imd, title = "IMD Decile - 2019",position = "topright")%>%
  setView(lng, lat, zoom = 9)

```

### Metadata

The data for this map is sourced from the 2019 Indices of Deprivation published by the **Ministry of Housing, Communities and Local Government**. The data can be found [here](https://www.gov.uk/government/statistics/english-indices-of-deprivation-2019).

# Population Age Demographics

## Over 60s {.tabset .tabset-fade}

### LSOA Map

The map below shows the percentage of the resident population in each LSOA across Cheshire & Merseyside that are aged 60 years or more as of the **mid-2020** population estimates from the ONS. The darker the colour, the higher the proportion of the population who are aged 60 or over.

```{r Pop 60 prep}

## Prep Age data
pop<-read.xlsx("https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/lowersuperoutputareamidyearpopulationestimates/mid2020sape23dt2/sape23dt2mid2020lsoasyoaestimatesunformatted.xlsx", sheet = 4, startRow = 5)

pop_cm<-pop%>%
  left_join(NW_LTLA, by = c("LA.Code.(2021.boundaries)" = "areaCode"))%>%
  filter(System == "Cheshire & Merseyside")%>%
  gather(Age, Pop, -c(1:7,99:103))%>%
  mutate(AgeGroup = case_when(Age %in% c("60", "61", "62", "63", "64", "65", "66", "67", "68", "69",
                                         "70", "71", "72", "73", "74", "75", "76", "77", "78", "79",
                                         "80", "81", "82", "83", "84", "85", "86", "87", "88", "89",
                                         "90+") ~ "60+",
                              TRUE ~ "Under 60"))%>%
  group_by(LSOA.Code, LSOA.Name, `LA.Code.(2018.boundaries)`, `LA.name.(2018.boundaries)`, `LA.Code.(2021.boundaries)`, `LA.name.(2021.boundaries)`, Region, System ,AgeGroup)%>%
  summarise(Pop = sum(Pop, na.rm =TRUE))%>%
  spread(AgeGroup, Pop)%>%
  mutate(Pop_60 = round((`60+`/(`60+` + `Under 60`))*100,2))


## Join Shape files with data
lsoa_data<-merge(lsoa, pop_cm, by.x = "LSOA11CD", "LSOA.Code")

### Filter for North West
lsoa_data_nw<-subset(lsoa_data, Region == "North West")


## Create palette
pal_con_a60<-colorNumeric("Greens", lsoa_data_nw$Pop_60)

```

```{r Pop 60 Map}


lat<-53.3
lng<--2.5

lsoa_data_cm<-subset(lsoa_data, System == "Cheshire & Merseyside")

lads_cm<-subset(lads_nw, System == "Cheshire & Merseyside")
leaflet(lsoa_data_cm)%>%
  addPolygons(data = lads_cm, color = "black", weight = 2)%>%
  addPolygons(stroke = TRUE, weight = 0.4, opacity = 1, fillOpacity = 0.6,
              color = "grey", fillColor = ~pal_con_a60(Pop_60),
              label = paste0(lsoa_data_cm$LSOA11NM,": Population 60+ - ", lsoa_data_cm$Pop_60))%>%
  addProviderTiles(providers$CartoDB.Voyager)%>%
  addLegend(values = lsoa_data_cm$Pop_60, pal = pal_con_a60, title = "Population 60+ %",position = "topright")%>%
  setView(lng, lat, zoom = 9)

```

### Metadata

The data for the map was sourced from the ONS mid-year population estimates for 2020 at LSOA level. The data used and more information on how these estimates are constructed can be found [here](https://www.ons.gov.uk/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/lowersuperoutputareamidyearpopulationestimates).


### Local Authority Population Pyramids

```{r pop pyramid}

pop_m<-read.xlsx("https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/lowersuperoutputareamidyearpopulationestimates/mid2020sape23dt2/sape23dt2mid2020lsoasyoaestimatesunformatted.xlsx", sheet = 5, startRow = 5)

pop_m<-pop_m%>%
  mutate(Sex = "Male")

pop_f<-read.xlsx("https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/lowersuperoutputareamidyearpopulationestimates/mid2020sape23dt2/sape23dt2mid2020lsoasyoaestimatesunformatted.xlsx", sheet = 6, startRow = 5)

pop_f<-pop_f%>%
  mutate(Sex = "Female")

pop_t<-rbind(pop_m, pop_f)

pop_cm_t<-pop_t%>%
  left_join(NW_LTLA, by = c("LA.Code.(2021.boundaries)" = "areaCode"))%>%
  filter(System == "Cheshire & Merseyside")%>%
  gather(Age, Pop, -c(1:7,99:104))%>%
  mutate(AgeGroup = case_when(Age %in% c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9") ~ "00-09",
                              Age %in% c("10", "11", "12", "13", "14", "15", "16", "17", "18", "19") ~ "10-19",
                              Age %in% c("20", "21", "22", "23", "24", "25", "26", "27", "28", "29") ~ "20-29",
                              Age %in% c("30", "31", "32", "33", "34", "35", "36", "37", "38", "39") ~ "30-39",
                              Age %in% c("40", "41", "42", "43", "44", "45", "46", "47", "48", "49") ~ "40-49",
                              Age %in% c("50", "51", "52", "53", "54", "55", "56", "57", "58", "59") ~ "50-59",
                              Age %in% c("60", "61", "62", "63", "64", "65", "66", "67", "68", "69") ~ "60-69",
                              Age %in% c("70", "71", "72", "73", "74", "75", "76", "77", "78", "79") ~ "70-79",
                              Age %in% c("80", "81", "82", "83", "84", "85", "86", "87", "88", "89") ~ "80-89",
                              TRUE ~ "90+"))
                                         
                                         
pop_cm_p<-pop_cm_t%>%
   group_by(`LA.Code.(2018.boundaries)`, `LA.name.(2018.boundaries)`, `LA.Code.(2021.boundaries)`, `LA.name.(2021.boundaries)`, Region, System, AgeGroup, Sex)%>%
  summarise(Pop = sum(Pop, na.rm =TRUE))
  


```


# Population Ethnicity Demographics

# Employment Status

## People in Employment {.tabset .tabset-fade}

### Local Authority Map

The map below shows the percentage of residents of each Local Authority across Cheshire & Merseyside aged between 16 and 64 years old who are in employment. The darker the colour, the higher the employment rate.

```{r In Emp Prep}

## Prep Employment data
emp<-fingertips_data(IndicatorID = 92313, AreaTypeID = 401)
map_ind_data_emp<-emp%>%
  filter(ParentName == "North West region",
         Timeperiod == '2020/21',
         Sex == "Persons",
         Age == "16-64 yrs")


## Joining LA Shape Data and Fingertips Data
lads_data_nw<-merge(lads_nw, map_ind_data_emp, by.x = "lad17cd",  "AreaCode")
lads_data_nw<-subset(lads_data_nw, Region == "North West")

## Creating Palettes
pal_con<-colorNumeric("Greens", lads_data_nw$Value)

```

```{r In Emp Map}

lat<-53.3
lng<--2.5

lads_data_cm<-subset(lads_data_nw, System == "Cheshire & Merseyside")

leaflet(lads_data_cm)%>%
  addPolygons(stroke = TRUE, weight = 1, opacity = 1, fillOpacity = 0.6,
              color = "black", fillColor = ~pal_con(Value),
              label = paste0(lads_data_cm$lad17nm,": ", lads_data_cm$Value," - (", round(lads_data_cm$LowerCI95.0limit,1)," - ",round(lads_data_cm$UpperCI95.0limit,1), ")"))%>%
  addProviderTiles(providers$CartoDB.Voyager)%>%
  addLegend(values = lads_data_cm$Value, pal = pal_con, title = "Percentage in Empoyment",position = "topright")%>%
  setView(lng, lat, zoom = 9)


```

### Metadata

The data to produce this map was sourced from the Fingertips Public Health Profiles produced by the **Office for Health Improvement & Disparities**. The tool can be accessed [here](https://fingertips.phe.org.uk/profile/public-health-outcomes-framework/data#page/3/gid/1000041/pat/6/par/E12000002/ati/401/are/E06000049/iid/92313/age/204/sex/4/cat/-1/ctp/-1/yrr/1/cid/4/tbm/1).

The underlying source of the data is taken from the annual Labour Force Survey.

## Sickness Absence {.tabset .tabset-fade}

### Local Authority Map

The map below shows the percentage of working days lost due to sickness absence between 2018 - 2020 for each Local Authority across Cheshire & Merseyside. The darker the colour, the higher the percentage of days lost.

```{r Emp Sick Prep}

## Prep Sickness data
emp_sick<-fingertips_data(IndicatorID = 90287, AreaTypeID = 401)
map_ind_data_sick<-emp_sick%>%
  filter(ParentName == "North West region",
         Timeperiod == "2018 - 20",
         Sex == "Persons")


## Joining LA Shape Data and Fingertips Data
lads_data_nw<-merge(lads_nw, map_ind_data_sick, by.x = "lad17cd",  "AreaCode")
lads_data_nw<-subset(lads_data_nw, Region == "North West")
lads_data_cm<-subset(lads_data_nw, System == "Cheshire & Merseyside")

## Creating Palettes
pal_con<-colorNumeric("Greens", lads_data_cm$Value)

```

```{r Emp Sick Map}

lat<-53.3
lng<--2.5



leaflet(lads_data_cm)%>%
  addPolygons(stroke = TRUE, weight = 1, opacity = 1, fillOpacity = 0.6,
              color = "black", fillColor = ~pal_con(Value),
              label = paste0(lads_data_cm$lad17nm,": ", round(lads_data_cm$Value,1)," - (", round(lads_data_cm$LowerCI95.0limit,1)," - ",round(lads_data_cm$UpperCI95.0limit,1), ")"))%>%
  addProviderTiles(providers$CartoDB.Voyager)%>%
  addLegend(values = lads_data_cm$Value, pal = pal_con, title = "Percentage Working Days Lost",position = "topright")%>%
  setView(lng, lat, zoom = 9)

```

### Metadata

The data to produce this map was sourced from the Fingertips Public Health Profiles produced by the **Office for Health Improvement & Disparities**. The tool can be accessed [here](https://fingertips.phe.org.uk/profile/public-health-outcomes-framework/data#page/3/gid/1000041/pat/6/par/E12000002/ati/401/are/E06000049/iid/90287/age/164/sex/4/cat/-1/ctp/-1/yrr/3/cid/4/tbm/1/page-options/car-do-0).

The underlying source of the data is taken from the annual Labour Force Survey and the ONS. Please note that for the coronavirus pandemic has impacted the underlying 2020 data in the following way:

-   Increased sickness absence due the virus
-   Decreased sickness absence due to furloughing, social distancing, shielding and increased homeworking which has reduced other causes of absence. Some of the decrease seen in 2020 will be because there were fewer people in work due to furlough.
-   Survey weighting methodology for the sample has changed slightly due to face-to-face interviewing being suspended.

## Gap in Employment Rate {.tabet .tabset-fade}

### Map

The map below shows the gap in the employment rate for people with a physical or mental health condition and the overall employment rate for each Local Authority across Cheshire & Merseyside in 2020/21. The darker the colour, the wider the gap in employment rates.

```{r Emp Gap Prep}

## Prep Sickness data
emp_gap<-fingertips_data(IndicatorID = 90282, AreaTypeID = 401)
map_ind_data_gap<-emp_gap%>%
  filter(ParentName == "North West region",
         Timeperiod == "2020/21",
         Sex == "Persons")


## Joining LA Shape Data and Fingertips Data
lads_data_nw<-merge(lads_nw, map_ind_data_gap, by.x = "lad17cd",  "AreaCode")
lads_data_nw<-subset(lads_data_nw, Region == "North West")
lads_data_cm<-subset(lads_data_nw, System == "Cheshire & Merseyside")

## Creating Palettes
pal_con<-colorNumeric("Greens", lads_data_cm$Value)

```

```{r Emp Gap Map}

lat<-53.3
lng<--2.5



leaflet(lads_data_cm)%>%
  addPolygons(stroke = TRUE, weight = 1, opacity = 1, fillOpacity = 0.6,
              color = "black", fillColor = ~pal_con(Value),
              label = paste0(lads_data_cm$lad17nm,": ", round(lads_data_cm$Value,1)," - (", round(lads_data_cm$LowerCI95.0limit,1)," - ",round(lads_data_cm$UpperCI95.0limit,1), ")"))%>%
  addProviderTiles(providers$CartoDB.Voyager)%>%
  addLegend(values = lads_data_cm$Value, pal = pal_con, title = "Employment Rate Gap",position = "topright")%>%
  setView(lng, lat, zoom = 9)

```

### Metadata

The data to produce this map was sourced from the Fingertips Public Health Profiles produced by the **Office for Health Improvement & Disparities**. The tool can be accessed [here](https://fingertips.phe.org.uk/profile/public-health-outcomes-framework/data#page/6/gid/1000041/pat/6/par/E12000002/ati/401/are/E06000049/iid/90282/age/204/sex/4/cat/-1/ctp/-1/yrr/1/cid/4/tbm/1/page-options/car-do-0).

Numerator for employment rate of people with a long term condition: Estimated (weighted) number of people with any physical or mental health condition or illness lasting or expected to last 12 months or more (based on responses in the Annual Population Survey) and who are in employment either as an employee, self employed, in government employment and training programmes or an unpaid family worker (the ILO definition of basic economic activity) and are of working age (aged 16 to 64).

# Education Status

## Level 8 Attaintment {.tabset .tabset-fade}

### Local Authority Map

The map below shows the Average Attaintment 8 score for all pupils at the end of Key Stage 4. The mean score for each Local Authority in Cheshire & Merseyside is shown with darker colours representing higher average scores. The score is shown on the map for each Local Authority alongside its corresponding 95% confidence interval.

```{r Edu A8 Prep}

## Prep Sickness data
edu_att<-fingertips_data(IndicatorID = 93378, AreaTypeID = 401)
map_ind_data_edu<-edu_att%>%
  filter(ParentName == "North West region",
         Timeperiod == "2020/21",
         Sex == "Persons")


## Joining LA Shape Data and Fingertips Data
lads_data_nw<-merge(lads_nw, map_ind_data_edu, by.x = "lad17cd",  "AreaCode")
lads_data_nw<-subset(lads_data_nw, Region == "North West")
lads_data_cm<-subset(lads_data_nw, System == "Cheshire & Merseyside")

## Creating Palettes
pal_con<-colorNumeric("Purples", lads_data_cm$Value)

```

```{r Edu A8 Map}

lat<-53.3
lng<--2.5



leaflet(lads_data_cm)%>%
  addPolygons(stroke = TRUE, weight = 1, opacity = 1, fillOpacity = 0.6,
              color = "black", fillColor = ~pal_con(Value),
              label = paste0(lads_data_cm$lad17nm,": ", round(lads_data_cm$Value,1)," - (", round(lads_data_cm$LowerCI95.0limit,1)," - ",round(lads_data_cm$UpperCI95.0limit,1), ")"))%>%
  addProviderTiles(providers$CartoDB.Voyager)%>%
  addLegend(values = lads_data_cm$Value, pal = pal_con, title = "Mean Score",position = "topright")%>%
  setView(lng, lat, zoom = 9)

```

### Metadata

The data to produce this map was sourced from the Fingertips Wider Determinants of Health profile produced by the **Office for Health Improvement & Disparities**. The tool can be accessed [here](https://fingertips.phe.org.uk/profile/wider-determinants/data#page/3/gid/1938133071/pat/6/par/E12000002/ati/401/are/E07000026/iid/93378/age/175/sex/4/cat/-1/ctp/-1/yrr/1/cid/4/tbm/1/page-options/car-do-0).

## Pupil Absence {.tabset .tabset-fade}

### Local Authority Map

The map below shows the percentage of half days missed by aged between 5 - 15 years due to overall absence (authorised and unauthorised) for each Local Authority within Cheshire & Merseyside during 2020/21. The darker the colour the higher the percentage of half days missed. The map shows the percentage missed for each Local Authority alongside the corresponding 95% confidence intervals.

```{r Edu Abs Prep}

## Prep Sickness data
edu_att<-fingertips_data(IndicatorID = 10301, AreaTypeID = 401)
map_ind_data_edu<-edu_att%>%
  filter(ParentName == "North West region",
         Timeperiod == "2020/21",
         Sex == "Persons")


## Joining LA Shape Data and Fingertips Data
lads_data_nw<-merge(lads_nw, map_ind_data_edu, by.x = "lad17cd",  "AreaCode")
lads_data_nw<-subset(lads_data_nw, Region == "North West")
lads_data_cm<-subset(lads_data_nw, System == "Cheshire & Merseyside")

## Creating Palettes
pal_con<-colorNumeric("Purples", lads_data_cm$Value)

```

```{r Edu Abs Map}

lat<-53.3
lng<--2.5



leaflet(lads_data_cm)%>%
  addPolygons(stroke = TRUE, weight = 1, opacity = 1, fillOpacity = 0.6,
              color = "black", fillColor = ~pal_con(Value),
              label = paste0(lads_data_cm$lad17nm,": ", round(lads_data_cm$Value,1)," - (", round(lads_data_cm$LowerCI95.0limit,1)," - ",round(lads_data_cm$UpperCI95.0limit,1), ")"))%>%
  addProviderTiles(providers$CartoDB.Voyager)%>%
  addLegend(values = lads_data_cm$Value, pal = pal_con, title = "Percentage of half days",position = "topright")%>%
  setView(lng, lat, zoom = 9)

```

### Metadata

The data to produce this map was sourced from the Fingertips Wider Determinants of Health profile produced by the **Office for Health Improvement & Disparities**. The tool can be accessed [here](https://fingertips.phe.org.uk/profile/wider-determinants/data#page/3/gid/1938133071/pat/6/par/E12000002/ati/401/are/E07000026/iid/10301/age/193/sex/4/cat/-1/ctp/-1/yrr/1/cid/4/tbm/1/page-options/car-do-0).

The underlying source of the data is from Pupil absence statistics published by the **Department for Education**.

# Car Ownership

# Co-morbidity Prevalance

# Drug Use

## Opiate or Crack Cocaine Users not in Treatment {.tabset .tabset-fade}

### Local Authority Map

The map below shows the percentage of Opiate and/or Crack Cocaine users who were not in contact with contact with drug treatment services for an OCU problem in 2020/21. Figures are shown for each Local Authority alongside their respective 95% confidence intervals. Darker colours indicate a higher percentage of users not in treatment.

```{r Drg Opi Prep}

## Prep Sickness data
drg_opi<-fingertips_data(IndicatorID = 93517, AreaTypeID = 402)
map_ind_data_drg<-drg_opi%>%
  filter(ParentName == "North West region",
         Timeperiod == "2020/21",
         Sex == "Persons")


## Joining LA Shape Data and Fingertips Data
lads_data_nw<-merge(lads_nw, map_ind_data_drg, by.x = "lad17cd",  "AreaCode")
lads_data_nw<-subset(lads_data_nw, Region == "North West")
lads_data_cm<-subset(lads_data_nw, System == "Cheshire & Merseyside")

## Creating Palettes
pal_con<-colorNumeric("Greens", lads_data_cm$Value)

```

```{r Drg Opi Map}

lat<-53.3
lng<--2.5



leaflet(lads_data_cm)%>%
  addPolygons(stroke = TRUE, weight = 1, opacity = 1, fillOpacity = 0.6,
              color = "black", fillColor = ~pal_con(Value),
              label = paste0(lads_data_cm$lad17nm,": ", round(lads_data_cm$Value,1)," - (", round(lads_data_cm$LowerCI95.0limit,1)," - ",round(lads_data_cm$UpperCI95.0limit,1), ")"))%>%
  addProviderTiles(providers$CartoDB.Voyager)%>%
  addLegend(values = lads_data_cm$Value, pal = pal_con, title = "Percentage of Users",position = "topright")%>%
  setView(lng, lat, zoom = 9)

```

### Metadata

The data to produce this map was sourced from the Fingertips Public Health Profiles produced by the **Office for Health Improvement & Disparities**. The tool can be accessed [here](https://fingertips.phe.org.uk/search/opiates#page/3/gid/1/pat/6/par/E12000002/ati/402/are/E06000008/iid/93517/age/182/sex/4/cat/-1/ctp/-1/yrr/1/cid/4/tbm/1/page-options/car-do-0).

The numerator estimates are taken from the **National Drug Treatment Monitoring System** and the estimates of the underlying denominator are taken from estimates of OCU Use in England, produced by **Liverpool John Moores University (LJMU)**.

## Deaths from Drug Misuse {.tabset .tabset-fade}

### Local Authority Map

The map below shows the directly standardised mortality rate per 100,000 population due to drug misuse for the period 2018 - 2020. Deaths where the underlying cause of death has been coded to particular categories of mental and behavioural disorders due to psychoactive substance use (excluding alcohol, tobacco and volatile solvents) registered in the calendar year for all ages. The darker the colour, the higher the mortality rate. Rates are shown on the map alongside the corresponding 95% confidence intervals.

```{r Drg Mort Prep}

## Prep Sickness data
drg_mrt<-fingertips_data(IndicatorID = 	92432, AreaTypeID = 401)
map_ind_data_drg<-drg_mrt%>%
  filter(ParentName == "North West region",
         Timeperiod == "2018 - 20",
         Sex == "Persons")


## Joining LA Shape Data and Fingertips Data
lads_data_nw<-merge(lads_nw, map_ind_data_drg, by.x = "lad17cd",  "AreaCode")
lads_data_nw<-subset(lads_data_nw, Region == "North West")
lads_data_cm<-subset(lads_data_nw, System == "Cheshire & Merseyside")

## Creating Palettes
pal_con<-colorNumeric("Greens", lads_data_cm$Value)

```

```{r Drg Mort Map}

lat<-53.3
lng<--2.5



leaflet(lads_data_cm)%>%
  addPolygons(stroke = TRUE, weight = 1, opacity = 1, fillOpacity = 0.6,
              color = "black", fillColor = ~pal_con(Value),
              label = paste0(lads_data_cm$lad17nm,": ", round(lads_data_cm$Value,1)," - (", round(lads_data_cm$LowerCI95.0limit,1)," - ",round(lads_data_cm$UpperCI95.0limit,1), ")"))%>%
  addProviderTiles(providers$CartoDB.Voyager)%>%
  addLegend(values = lads_data_cm$Value, pal = pal_con, title = "DSR per 100,000",position = "topright")%>%
  setView(lng, lat, zoom = 9)

```

### Metadata

The data to produce this map was sourced from the Fingertips Public Health Profiles produced by the **Office for Health Improvement & Disparities**. The tool can be accessed [here](https://fingertips.phe.org.uk/search/drug%20death#page/3/gid/1/pat/6/par/E12000002/ati/401/are/E07000026/iid/92432/age/1/sex/4/cat/-1/ctp/-1/yrr/3/cid/4/tbm/1/page-options/car-do-0).

Deaths where the underlying cause of death has been coded to the following categories of mental and behavioural disorders due to psychoactive substance use (excluding alcohol, tobacco and volatile solvents):

1. opioids (F11)
2. cannabinoids (F12)
3. sedatives or hypnotics (F13)
4. cocaine (F14)
5. other stimulants, including caffeine (F15)
6. hallucinogens (F16) and
7. multiple drug use and use of other psychoactive substances (F19)

**AND**

Deaths coded to the following categories and where a drug controlled under the Misuse of Drugs Act 1971 was mentioned on the death record:

1. Accidental poisoning by drugs, medicaments and biological substances (X40--X44)
2. Intentional self-poisoning by drugs, medicaments and biological substances (X60--X64)
3. Poisoning by drugs, medicaments and biological substances, undetermined intent (Y10--Y14)
4. Assault by drugs, medicaments and biological substances (X85) and
5. Mental and behavioural disorders due to use of volatile solvents (F18)

# Alcohol Use

## Alcohol Specific Admissions {.tabset .tabset-fade}

### Local Authority Map

The map below shows the Directly Standardised Rate per 100,000 of alcohol specific admissions to hospital during 2020/21. Alcohol specific admissions relate to an admission where the primary diagnosis or any secondary diagnosis are an alcohol specific (wholly attributable) condition. The darker the colour, the higher the rate of admissions. Admission rates are shown alongside the associated 95% Confidence Intervals.

```{r Alc Adm Prep}

## Prep Sickness data
alc_adm<-fingertips_data(IndicatorID = 92906, AreaTypeID = 401)
map_ind_data_alc<-alc_adm%>%
  filter(ParentName == "North West region",
         Timeperiod == "2020/21",
         Sex == "Persons")


## Joining LA Shape Data and Fingertips Data
lads_data_nw<-merge(lads_nw, map_ind_data_alc, by.x = "lad17cd",  "AreaCode")
lads_data_nw<-subset(lads_data_nw, Region == "North West")
lads_data_cm<-subset(lads_data_nw, System == "Cheshire & Merseyside")

## Creating Palettes
pal_con<-colorNumeric("Greens", lads_data_cm$Value)

```

```{r Alc Adm Map}

lat<-53.3
lng<--2.5



leaflet(lads_data_cm)%>%
  addPolygons(stroke = TRUE, weight = 1, opacity = 1, fillOpacity = 0.6,
              color = "black", fillColor = ~pal_con(Value),
              label = paste0(lads_data_cm$lad17nm,": ", round(lads_data_cm$Value,1)," - (", round(lads_data_cm$LowerCI95.0limit,1)," - ",round(lads_data_cm$UpperCI95.0limit,1), ")"))%>%
  addProviderTiles(providers$CartoDB.Voyager)%>%
  addLegend(values = lads_data_cm$Value, pal = pal_con, title = "DSR per 100,000",position = "topright")%>%
  setView(lng, lat, zoom = 9)

```

### Metadata

The data to produce this map was sourced from the Fingertips Public Health Profiles produced by the **Office for Health Improvement & Disparities**. The tool can be accessed [here](https://fingertips.phe.org.uk/search/alcohol#page/3/gid/1/pat/6/par/E12000002/ati/401/are/E07000026/iid/92906/age/1/sex/4/cat/-1/ctp/-1/yrr/1/cid/4/tbm/1/page-options/car-do-0).

Admissions data is sourced from Hospital Episode Statistics (HES) via **NHS Digital** and population estimates via **ONS**.

## Alcohol Licensed Premises {.tabset .tabset-fade}

### Local Authority Map

The map below shows the number of premises per square kilometre that were licensed to sell alcohol during 2017/18 across Cheshire & Merseyside. The darker the colour, the higher the number of premises. Figures on the map correspond to the rate with the associated 95% confidence intervals.

```{r Alc Prem Prep}

## Prep Sickness data
alc_prem<-fingertips_data(IndicatorID = 92772, AreaTypeID = 401)
map_ind_data_alc<-alc_prem%>%
  filter(ParentName == "North West region",
         Timeperiod == "2017/18",
         Sex == "Not applicable")


## Joining LA Shape Data and Fingertips Data
lads_data_nw<-merge(lads_nw, map_ind_data_alc, by.x = "lad17cd",  "AreaCode")
lads_data_nw<-subset(lads_data_nw, Region == "North West")
lads_data_cm<-subset(lads_data_nw, System == "Cheshire & Merseyside")

## Creating Palettes
pal_con<-colorNumeric("Greens", lads_data_cm$Value)

```

```{r Alc Prem Map}

lat<-53.3
lng<--2.5



leaflet(lads_data_cm)%>%
  addPolygons(stroke = TRUE, weight = 1, opacity = 1, fillOpacity = 0.6,
              color = "black", fillColor = ~pal_con(Value),
              label = paste0(lads_data_cm$lad17nm,": ", round(lads_data_cm$Value,1)," - (", round(lads_data_cm$LowerCI95.0limit,1)," - ",round(lads_data_cm$UpperCI95.0limit,1), ")"))%>%
  addProviderTiles(providers$CartoDB.Voyager)%>%
  addLegend(values = lads_data_cm$Value, pal = pal_con, title = "Premises per square KM",position = "topright")%>%
  setView(lng, lat, zoom = 9)

```

### Metadata

The data to produce this map was sourced from the Fingertips Public Health Profiles produced by the **Office for Health Improvement & Disparities**. The tool can be accessed [here](https://fingertips.phe.org.uk/search/alcohol#page/3/gid/1/pat/6/par/E12000002/ati/401/are/E07000026/iid/92772/age/-1/sex/-1/cat/-1/ctp/-1/yrr/1/cid/4/tbm/1/page-options/car-do-0).

The original source of the data is **Public Health England: Risk Factors Intelligence (RFI) team** (from published data from the Home Office).

## Alcohol Specific Mortality {.tabset .tabset-fade}

### Local Authority Map

The map below shows the directly standardised mortality rate per 100,000 population due to alcohol specific causes for the period 2017 - 2019. Alcohol specific causes are deaths which have been wholly caused by alcohol consumption, registered in the calendar year for all ages. The darker the colour, the higher the mortality rate. Rates are shown on the map alongside the corresponding 95% confidence intervals.

```{r Alc Mort Prep}

## Prep Sickness data
alc_mort<-fingertips_data(IndicatorID = 91380, AreaTypeID = 401)
map_ind_data_alc<-alc_mort%>%
  filter(ParentName == "North West region",
         Timeperiod == "2017 - 19",
         Sex == "Persons")


## Joining LA Shape Data and Fingertips Data
lads_data_nw<-merge(lads_nw, map_ind_data_alc, by.x = "lad17cd",  "AreaCode")
lads_data_nw<-subset(lads_data_nw, Region == "North West")
lads_data_cm<-subset(lads_data_nw, System == "Cheshire & Merseyside")

## Creating Palettes
pal_con<-colorNumeric("Greens", lads_data_cm$Value)

```

```{r Alc Mort Map}

lat<-53.3
lng<--2.5



leaflet(lads_data_cm)%>%
  addPolygons(stroke = TRUE, weight = 1, opacity = 1, fillOpacity = 0.6,
              color = "black", fillColor = ~pal_con(Value),
              label = paste0(lads_data_cm$lad17nm,": ", round(lads_data_cm$Value,1)," - (", round(lads_data_cm$LowerCI95.0limit,1)," - ",round(lads_data_cm$UpperCI95.0limit,1), ")"))%>%
  addProviderTiles(providers$CartoDB.Voyager)%>%
  addLegend(values = lads_data_cm$Value, pal = pal_con, title = "DSR per 100,000",position = "topright")%>%
  setView(lng, lat, zoom = 9)

```

### Metadata

The data to produce this map was sourced from the Fingertips Public Health Profiles produced by the **Office for Health Improvement & Disparities**. The tool can be accessed [here](https://fingertips.phe.org.uk/search/alcohol%20mortality#page/3/gid/1938132832/pat/6/par/E12000002/ati/401/are/E07000026/iid/91380/age/1/sex/4/cat/-1/ctp/-1/yrr/3/cid/4/tbm/1/page-options/car-do-0).

# Smoking

## Active Smokers {.tabset .tabset-fade}

```{r Active Smoke Prep}

## Read Data
smk_act_data<- fingertips_data(IndicatorID = 90452, AreaTypeID = 167)
map_ind_data<-smk_act_data%>%
  filter(AreaCode %in% c("E38000015","E38000217","E38000091","E38000143","E38000014","E38000101",
                         "E38000080","E38000068","E38000050","E38000205","E38000135","E38000227",
                         "E38000024","E38000172","E38000182","E38000161","E38000194","E38000174",
                         "E38000200","E38000034","E38000016","E38000208","E38000228","E38000233",
                         "E38000226","E38000170","E38000187"),
         Timeperiod == '2021')


###Filter shapes for North West only
NW_CCG<-read_excel("ref/NW_CCG.xlsx")
ccg_nw<-merge(ccg, NW_CCG, by.x = "CCG21CD", "Area Code")
ccg_nw<-subset(ccg_nw, Region == "North West")

## Joining LA Shape Data and Fingertips Data
ccg_data_nw<-merge(ccg_nw, map_ind_data, by.x = "CCG21CD", "AreaCode")
ccg_data_nw<-subset(ccg_data_nw, Region == "North West")

## Create palette
pal_con_asmk<-colorNumeric("Oranges", ccg_data_nw$Value)

```

### CCG Map

```{r Active Smoke Map}


lat<-53.3
lng<--2.5

ccg_data_cm<-subset(ccg_data_nw, System == "Cheshire & Merseyside")


leaflet(ccg_data_cm)%>%
  addPolygons(stroke = TRUE, weight = 1, opacity = 1, fillOpacity = 0.6,
              color = "black", fillColor = ~pal_con_asmk(Value),
              label = paste0(ccg_data_cm$CCG21NM,": ", round(ccg_data_cm$Value,1)," - (", round(ccg_data_cm$LowerCI99.8limit,1)," - ",round(ccg_data_cm$UpperCI99.8limit,1), ")"))%>%
  addProviderTiles(providers$CartoDB.Voyager)%>%
  addLegend(values = ccg_data_cm$Value, pal = pal_con_asmk, title = "Active Smoking (%)",position = "topright")%>%
  setView(lng, lat, zoom = 9)

```

### Metadata

The data to produce this map was sourced from the Fingertips Public Health Profiles produced by the **Office for Health Improvement & Disparities**. The tool can be accessed [here](https://fingertips.phe.org.uk/search/smoking#page/3/gid/1/pat/220/par/E54000008/ati/167/iid/90452/age/164/sex/4/cat/-1/ctp/-1/yrr/1/cid/4/tbm/1/page-options/car-do-0).

<br/>

The data for this measure originates form the **GP Survey** Question 59. People were asked: "Which of the following best describes your smoking habits?". The indicator value is the percentage of people who answered this question with "Occasional smoker" or "Regular smoker" from all responses to this question.
